name: Build and Deploy to GCP

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [ closed ]
  workflow_dispatch: 

jobs:
  build:
    name: ğŸ”¨ Build JAR
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Check out code
      uses: actions/checkout@v4
    
    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: ğŸ”§ Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: ğŸ”¨ Build with Maven
      run: mvn clean package -DskipTests
    
    - name: ğŸ“¦ Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: vehicle-status-jar
        path: target/*.jar
        retention-days: 1

  deploy:
    name: ğŸš€ Deploy to GCP
    needs: build
    # åªåœ¨æ¨é€åˆ° main åˆ†æ”¯æˆ– PR åˆå¹¶æ—¶è¿è¡Œ
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true) || github.event_name == 'workflow_dispatch'
    
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Check out code
      uses: actions/checkout@v4
    
    - name: ğŸ“¦ Download JAR artifact
      uses: actions/download-artifact@v4
      with:
        name: vehicle-status-jar
        path: ./target
    
    # é…ç½®SSHå¯†é’¥
    - name: ğŸ” Install SSH key
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.GCP_SSH_KEY }}
        known_hosts: unnecessary
        if_key_exists: replace
    
    # æ‰‹åŠ¨æŸ¥è¯¢æœåŠ¡å™¨å…¬é’¥ï¼Œå¹¶ä¸”æ·»åŠ æœåŠ¡å™¨åˆ°known_hosts
    - name: ğŸ“‹ Add server to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.VM_IP }} >> ~/.ssh/known_hosts
    
    - name: ğŸš€ Deploy to GCP
      env: # å£°æ˜ä¸€äº›å˜é‡ï¼Œä¸‹é¢ä¼šç”¨åˆ°
        HOST: ${{ secrets.VM_IP }}
        PROJECT_NAME: vehicle-status-service
        DEPLOY_PATH: /root/vehicle-status
      run: |
        # ç¡®ä¿JARæ–‡ä»¶å­˜åœ¨
        ls -la target/
        JAR_FILE=$(ls target/*.jar | head -n 1)
        echo "ğŸ“¦ æ‰¾åˆ°JARæ–‡ä»¶: $JAR_FILE"
        
        # åˆ›å»ºéƒ¨ç½²ç›®å½•ç»“æ„
        mkdir -p deploy-package
        cp $JAR_FILE deploy-package/app.jar
        cp Dockerfile deploy-package/
        cp -r src/main/resources deploy-package/ 2>/dev/null || true
        
        # åˆ›å»ºéƒ¨ç½²è„šæœ¬
        cat > deploy-package/deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ğŸ¯ å¼€å§‹åœ¨VMä¸Šéƒ¨ç½²..."
        
        # åˆ›å»ºéƒ¨ç½²ç›®å½•
        mkdir -p /root/vehicle-status
        cd /root/vehicle-status
        
        echo "ğŸ“‚ å½“å‰ç›®å½•: $(pwd)"
        
        # åœæ­¢æ—§å®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        echo "ğŸ›‘ åœæ­¢æ—§å®¹å™¨..."
        docker stop vehicle-status-app 2>/dev/null || true
        docker rm vehicle-status-app 2>/dev/null || true
        
        # æ„å»ºDockeré•œåƒ
        echo "ğŸ”¨ æ„å»ºDockeré•œåƒ..."
        docker build -t vehicle-status-service:latest . || {
          echo "âŒ Dockeré•œåƒæ„å»ºå¤±è´¥"
          exit 1
        }
        
        # å¯åŠ¨æ–°å®¹å™¨
        echo "ğŸš€ å¯åŠ¨åº”ç”¨å®¹å™¨..."
        docker run -d \
          --name vehicle-status-app \
          --restart unless-stopped \
          -p 8080:8080 \
          -e SPRING_PROFILES_ACTIVE=production \
          --memory="1g" \
          --cpus="1.0" \
          vehicle-status-service:latest || {
          echo "âŒ å®¹å™¨å¯åŠ¨å¤±è´¥"
          exit 1
        }
        
        # ç­‰å¾…åº”ç”¨å¯åŠ¨
        echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨..."
        sleep 30
        
        # å¥åº·æ£€æŸ¥
        echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        for i in {1..10}; do
          if curl -f http://localhost:8080/api/vehicle-status/speed/TEST >/dev/null 2>&1; then
            echo "âœ… åº”ç”¨å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
            break
          elif [ $i -eq 10 ]; then
            echo "âŒ åº”ç”¨å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
            docker logs vehicle-status-app --tail 20
            exit 1
          else
            echo "â³ å¥åº·æ£€æŸ¥ç¬¬ $i æ¬¡å¤±è´¥ï¼Œç­‰å¾…é‡è¯•..."
            sleep 10
          fi
        done
        
        # æ˜¾ç¤ºéƒ¨ç½²ç»“æœ
        echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
        echo "ğŸŒ åº”ç”¨è®¿é—®åœ°å€: http://$(curl -s ifconfig.me):8080"
        echo "ğŸ“Š å®¹å™¨çŠ¶æ€:"
        docker ps | grep vehicle-status
        
        # æ¸…ç†æ—§é•œåƒ
        echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
        docker image prune -f
        
        EOF
        
        # è®¾ç½®è„šæœ¬æƒé™
        chmod +x deploy-package/deploy.sh
        
        # å°†éƒ¨ç½²åŒ…ä¼ è¾“åˆ°VM
        echo "ğŸ“¤ ä¼ è¾“éƒ¨ç½²åŒ…åˆ°VM..."
        scp -r deploy-package/* root@$HOST:/root/vehicle-status/
        
        # åœ¨VMä¸Šæ‰§è¡Œéƒ¨ç½²è„šæœ¬
        echo "ğŸ”„ åœ¨VMä¸Šæ‰§è¡Œéƒ¨ç½²..."
        ssh -o StrictHostKeyChecking=no root@$HOST 'cd /root/vehicle-status && ./deploy.sh' 